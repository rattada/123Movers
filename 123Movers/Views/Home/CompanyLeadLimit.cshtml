@model _123Movers.Models.LeadLimitModel
@using _123Movers.Models;
@{
    ViewBag.Title = "Company Lead Limit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<input type="hidden" id="message" value="@ViewBag.Success"/>
<input type="hidden" id="hdnServiceId" value="@ViewBag.ServiceID"/>

@Html.Partial("_CompanyInfo")

<p class="clearfix"></p>
@*@using (Html.BeginForm("CompanyLeadLimit", "Home", FormMethod.Post, new { id = "frmLeadLimit" }))
{  *@
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)

   <div class="table-responsive">
        <table id="tblLeadLimit" class="table table-striped table-bordered tablesorter">
            <thead>
                <tr>
                    <th style="height: 5px;">Select</th>
                    <th>Service
                    </th>

                    <th>AreaCode
                    </th>

                    <th>Frequency
                    </th>

                    <th>Daily Limit
                    </th>
                    <th>Monthly Limit
                    </th>
                    <th>Total Limit
                    </th>

                </tr>
            </thead>
            <tbody>
                        <tr >
                    <td><input type="checkbox" name="group1" class='chkSelectClass' id="rdbtnBoth"></td>
                    <td id="tdBoth">BOTH
                    </td>
                    <td>Default
                    </td>
                    <td><input type="text" id="txtBothFrequency" class="textBoxWidth" >
                    </td>
                    <td>
                        <input type="checkbox" id="chkBothDaily" class="chkInnerClass">
                        Daily Lead Limit:<input type="text" id="txtBothDaily" disabled="disabled" class="textBoxWidth"  ><br>
                    </td>
                    <td>
                        <input type="checkbox" id="chkBothMonthly" class="chkInnerClass">
                        Monthly Lead Limit:<input type="text" id="txtBothMonthly" disabled="disabled" class="textBoxWidth" ><br>
                    </td>
                    <td>
                        <input type="checkbox" id="chkBothTotal" class="chkInnerClass">
                        Total Lead Limit:<input type="text" id="txtBothTotal" disabled="disabled" class="textBoxWidth" ><br>
                    </td>

                </tr>
                <tr>
                    <td colspan="7" align="center" id="tdOR">--OR--
                    </td>
                </tr>



                <tr ><td><input type="checkbox" name="group2" class='chkSelectClass' id="rdbtnLocal"></td>
                    <td id="tdLocal">Local
                    </td>
                    <td>Default
                    </td>
                    <td><input type="text" id="txtLocalFrequency" class="textBoxWidth">
                    </td>
                    <td>
                        <input type="checkbox" id="chkLocalDaily" class="chkInnerClass">
                        Daily Lead Limit:<input type="text" id="txtLocalDaily" disabled="disabled" class="textBoxWidth"><br>
                    </td>
                    <td>
                        <input type="checkbox" id="chkLocalMonthly" class="chkInnerClass">
                        Monthly Lead Limit:<input type="text" id="txtLocalMonthly" disabled="disabled" class="textBoxWidth"><br>
                    </td>
                    <td>
                        <input type="checkbox" name="chkLocalTotal" class="chkInnerClass">
                        Total Lead Limit:<input type="text" id="txtLocalTotal" disabled="disabled" class="textBoxWidth"><br>
                    </td>

                </tr>



                <tr ><td><input type="checkbox" name="group2" class='chkSelectClass' id="rdbtnLong"></td>
                    <td id="tdLong">Long
                    </td>
                    <td>Default
                    </td>
                    <td><input type="text" id="txtLongFrequency" class="textBoxWidth" >
                    </td>
                    <td>
                        <input type="checkbox" id="chkLongDaily" class="chkInnerClass" >
                        Daily Lead Limit:<input type="text" id="txtLongDaily" disabled="disabled" class="textBoxWidth"><br>
                    </td>
                    <td>
                        <input type="checkbox" id="chkLongMonthly" class="chkInnerClass">
                        Monthly Lead Limit:<input type="text" id="txtLongMonthly" disabled="disabled" class="textBoxWidth"><br>
                    </td>
                    <td>
                        <input type="checkbox" id="chkLongTotal" class="chkInnerClass">
                        Total Lead Limit:<input type="text" id="txtLongTotal" disabled="disabled" class="textBoxWidth"><br>
                    </td>

                </tr>

                <tr>
                    <td colspan="7" align="center" id="tdExisting">--OR--
                    </td>
                </tr>

                @if (@Model.LeadLimitData != null)
                {
                    if (@Model.LeadLimitData.Count() > 0)
                    {
                        
       
                    foreach (var leadlimit in Model.LeadLimitData)
                    {
                       


                        if (@leadlimit.ServiceId != null && @leadlimit.AreaCodes != null)
                        {
                            var Service = (@leadlimit.ServiceId == 1009) ? "Local" : "Long";
                            var areaCode = (@leadlimit.AreaCodes == null) ? "Default" : @leadlimit.AreaCodes;

                            //if (@leadlimit.AreaCodes == null)
                            //Count = Count + 1;

                                <tr>

                                    <td>
                                        <input type="checkbox"   class='chkSelectClass' id="rdbtn@(areaCode)"></td>
                                    <td>@Service
                                    </td>
                                    <td>@areaCode
                                    </td>
                                    <td>
                                        <input type="text" id="txtFrequency@(areaCode)" value="@leadlimit.LeadFrequency" class="textBoxWidth">
                                    </td>
                                    <td>
                                        <input type="checkbox" id="chkDaily@(areaCode)" class="chkInnerClass"  checked="@leadlimit.IsDailyLeadLimit">
                                     
                                        
                                        Daily Lead Limit:<input type="text" class="classCheckVal textBoxWidth" id="txtDaily@(areaCode)" value="@leadlimit.DailyLeadLimit" disabled="disabled"><br>
                                    </td>
                                    <td>
                                        <input type="checkbox" id="chkMonthly@(areaCode)" class="chkInnerClass" checked="@leadlimit.IsMonthlyLeadLimit">
                                        Monthly Lead Limit:<input type="text" class="classCheckVal textBoxWidth"  id ="txtMonthly@(areaCode)" value="@leadlimit.MonthlyLeadLimit" disabled="disabled"><br>
                                    </td>
                                    <td>
                                        <input type="checkbox" id="chkTotal@(areaCode)" class="chkInnerClass" checked="@leadlimit.IsTotalLeadLimit">
                                        Total Lead Limit:<input type="text" class="classCheckVal textBoxWidth"  id="txtTotal@(areaCode)" value="@leadlimit.TotalLeadLimit" disabled="disabled"><br>
                                    </td>
                                </tr>
                        }

                    }              
                        
                        
                }
                         
              }
                else
                
                {
                    <tr>
                  <td colspan="7" align="center">
                      No Records found
                                    </td></tr>
                }
            </tbody>
        </table>
    </div>
    <div class="row">
        <input type="button" id="saveleads" class="btn btn-primary pull-right" value="Save Leads" />
        <a href="#" onclick="history.go(-1);return false;" class="btn btn-primary btnSpacing">Back To Edit</a>

    </div>
    
@*}*@

<script type="text/javascript">
    $(function () {
        jQuery.each($(".classCheckVal "), function (i, val) {
            if ($(this).find("input[type=text]").prop("value") == 0) {

                $(".classCheckVal ").find("input[type=text]").prop("disabled", "disabled")
            }
            else {
                ($(this).find("input[type=text]").prop("disabled", false));
            }

        });

        //if ($(".classCheckVal ").find("input[type=text]").prop("value") == "") {

        //    $("#chkInnerClass").prop("checked", false);
        //    $(".classCheckVal ").find("input[type=text]").prop("disabled", "disabled")
        //}
        //else {

        //    $("#chkInnerClass").prop("checked", true);
        //    $(".classCheckVal ").find("input[type=text]").prop("disabled", false);
        //}



        $("#saveleads").click(function () {
            var count = 0;
            var required = "";
            var Array = [];
            var values = "";
            var LeadLimitData = [];
            var Filleddata = [];
            $('#tblLeadLimit tbody tr').each(function () {

                //Checking for Only checked checkboxes

                $(this).find('.chkSelectClass:checkbox:checked').each(function () {


                    var row = $(this).closest('tr');
                    var columns = row.find('td');


                    $.each(columns, function (i, item) {
                        if (i > 2) {
                            values = values + "," + $(this).closest('td').find("input:text").val().trim();

                        }
                        else {
                            if (i == 0)
                                values = item.textContent;
                            else
                                values = values + "," + item.textContent.trim();
                        }



                    });
                    //saving lsit of checked item data in a Array.
                    Array.push(values);
                });
            });


            //looping through the Array  and storing in a Array list 
            $.each(Array, function (i, item) {

                required = item.split(",")


                if (required[2] == 'Default') {
                    required[2] = null;

                }
                //if (required[3] == 'Default') {
                //    required[3] = null;

                //}

                if (required[1] == 'Local') {
                    required[1] = 1009;

                }
                else if (required[1] == 'Long') {
                    required[1] = 1000;

                }
                else {
                    required[1] = null;
                }


                LeadLimitData =
               [{
                   AreaCodes: required[2],
                   ServiceId: required[1],
                   LeadFrequency: required[3],
                   DailyLeadLimit: required[4],
                   MonthlyLeadLimit: required[5],
                   TotalLeadLimit: required[6]
               }]

                Filleddata.push(LeadLimitData);

            });

            //Saving the  entire data in DB with Ajax call

            if (Filleddata.length != 0) {
                $.ajax({

                    url: '/Home/CompanyLeadLimit',
                    cache: false,
                    type: 'POST',
                    dataType: "json",
                    data: JSON.stringify(Filleddata),// Comverting the list items to JSON format(Because POST method accepts  only JSON data)
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        alert('Successfully Updated:');
                        location.reload();
                    },
                    error: function () {
                        alert('Service call failed');
                    }
                });

            }
            else {
                alert("Please Select any");
                return false;

            }

        });


        $("body #tblLeadLimit ").parent().on('change', ".chkInnerClass", function () {

            if ($(this).prop('checked') == true) {
                $(this).closest("td").find("input[type=text]").prop("value", "");
                $(this).closest("td").find("input[type=text]").prop("disabled", false);
            }
            else {
                $(this).closest("td").find("input[type=text]").prop("value", "");
                $(this).closest("td").find("input[type=text]").prop("disabled", true);
            }
        });


        $("body #tblLeadLimit ").parent().on('change', "#rdbtnBoth,#rdbtnLocal,#rdbtnLong", function () {

            if ($(this).attr("id") != "rdbtnLocal" && $(this).attr("id") != "rdbtnLong") {

                if ($("#rdbtnBoth").prop('checked') == true) {

                    $("input[name='group2']").prop("checked", false);
                }
            }
            else {
                if ($("input[name='group1']").prop("checked") == true) {

                    $("input[name='group1']").prop("checked", false);
                }
            }

        });



    });
    </script>